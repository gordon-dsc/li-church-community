---
title: "Data Cleaning Script"
format: html
---

```{r packages}
library(tidyverse)
library(rvest)
library(readr)
library(httr2)
library(purrr)
library(janitor)
library(stringr)
library(sf)
library(ggmap)
library(maps)
library(janitor)
```

```{r}
#Filter out Non Religious Organizations. Add Full Address Column to be Searched on. Trim Zip Code
eo_ny <- eo_ny|>
  filter(SUBSECTION == "03",
         FOUNDATION == "10")|>
  mutate(full_address = str_c(STREET, CITY, STATE, ZIP, sep = "_"),
         zip_code = str_extract(ZIP, pattern = "[0-9]{5}"))
```
```{r}
#Clean scraped zip code data from website
zip_codes|>
  mutate(row_num = row_number())|>
  filter(row_num == 14)|>
  unnest_longer(col = zip_scraped)|>
  filter(str_length(zip_scraped) > 1)|>
  mutate(zip_code = str_extract(zip_scraped, pattern = "[0-9]{5}"))|>
  mutate(city = str_remove(zip_scraped, pattern = "[0-9]{5}"))|>
  dplyr::select(zip_code, city) -> li_zip_codes
```

```{r}
#Filter eo_ny by zip code. 
li_churches <- li_zip_codes|>
  left_join(eo_ny, by = "zip_code")
```

```{r}
#filter out non Christian churches with keywords. 
li_churches|>
  mutate(ntee_code = str_extract(NTEE_CD, pattern = "[0-9]{2}"),
         ntee_code = as.numeric(ntee_code))|>
  filter(is.na(ntee_code) | between(ntee_code, 20, 22))|>
  filter(!str_detect(NAME, regex("islam", ignore_case = TRUE)),
         !str_detect(NAME, regex("school", ignore_case = TRUE)),
         !str_detect(NAME, regex("trust", ignore_case = TRUE)),
         !str_detect(NAME, regex("israel", ignore_case = TRUE)),
         !str_detect(NAME, regex("synagogue", ignore_case = TRUE)),
         !str_detect(NAME, regex("quran", ignore_case = TRUE)),
         !str_detect(NAME, regex("synogogue", ignore_case = TRUE)),
         !str_detect(NAME, regex("masjid", ignore_case = TRUE)),
         !str_detect(NAME, regex("jew", ignore_case = TRUE)),
         !str_detect(NAME, regex("torah", ignore_case = TRUE)),
         !is.na(NAME))|>
  distinct(NAME, .keep_all = TRUE)-> li_churches
```

```{r}
#filter by coordinates
map_data_li|>
  summarize(max_lat = max(lat),
            min_lat = min(lat),
            max_lon = max(long),
            min_lon = min(long)) -> li_boundaries

li_churches_coordinates|>
  unnest_longer(col = geo_loc)|>
  filter(!str_detect(geo_loc, pattern = "NA"))|>
  unnest_wider(col = geo_loc)|>
  distinct(EIN, .keep_all = TRUE)|>
  mutate(lat = as.numeric(lat),
    lon = as.numeric(lon))|>
  filter(between(lat, li_boundaries$min_lat, li_boundaries$max_lat),
         between(lon, li_boundaries$min_lon, li_boundaries$max_lon))-> map_data
```

```{r}
#create column of all dhc groups. 
#not used in final csv
dhc_groups <- tibble(dhc_groups)

dhc_groups|>
  mutate(dhc_groups = na_if(dhc_groups, ""))|>
  drop_na()-> dhc_groups
```

```{r}
#wrangle data from census api request 
li_race_data <- tibble(li_race_data)

li_race_data|>
  unnest_longer(col = li_race_data)|>
  unnest_wider(col = li_race_data, names_sep = "_")|>
  distinct()|>
  row_to_names(1)|>
  select(-ends_with("A"))-> li_race_data
```


```{r}
#get colnames from race web page variables
race_web_page <- tibble(race_web_page)

race_web_page |>
  rename(web_info = race_web_page)|>
  filter(str_detect(web_info, pattern = "^[P!]")) -> race_web_page

race_web_page |>
  filter(!str_detect(web_info, pattern = "^P8$"))|>
  pivot_wider(names_from = web_info, values_from = web_info)|>
  select(-starts_with("P"))|>
  mutate(GEO_ID = "GEOID",
         NAME = "NAME",
         state = "state",
         county = "county",
         tract = "tract",
         block_group = "block_group")|>
  relocate(
    GEO_ID,
    NAME,
    .before = 1) |>
  relocate(
    state, county, tract, block_group,
    .after = last_col()) -> race_cols

colnames(li_race_data) <- unlist(race_cols[1, ], use.names = FALSE)
```

```{r}
#clean up column names, extract geoid
li_race_data |>
  janitor::clean_names()|>
  mutate(geoid = str_remove_all(geoid, pattern = "1500000US"))|>
  left_join(long_island_bg, by = "geoid")|>
  mutate(geoid = as.character(geoid)) -> li_race_data_clean
```

```{r}
#spacial join
map_data_sf <- st_as_sf(map_data, coords = c("lon", "lat"), crs = 4326)
li_race_data_clean <- st_as_sf(li_race_data_clean, sf_column_name = "geometry")
st_crs(li_race_data_clean) <- 4326

st_crs(li_race_data_clean)
st_crs(map_data_sf)


joined_data <- st_join(map_data_sf, li_race_data_clean, join = st_within)
```

```{r}
#clean household columns names
household_table <- tibble(col = household_table)
household_columns <- household_table[[1]][[1]]

household_columns |>
  select(Label) |>
  pivot_wider(names_from = Label, values_from = Label) -> household_cols
  
```

