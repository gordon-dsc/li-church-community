---
title: "Data Cleaning Script"
format: html
---

```{r packages}
library(tidyverse)
library(rvest)
library(readr)
library(httr2)
library(purrr)
library(janitor)
library(stringr)
library(sf)
library(ggmap)
library(maps)
library(janitor)
```

```{r}
#Filter out Non Religious Organizations. Add Full Address Column to be Searched on. Trim Zip Code
eo_ny <- eo_ny|>
  filter(SUBSECTION == "03",
         FOUNDATION == "10")|>
  mutate(full_address = str_c(STREET, CITY, STATE, ZIP, sep = "_"),
         zip_code = str_extract(ZIP, pattern = "[0-9]{5}"))
```
```{r}
#Clean scraped zip code data from website
zip_codes|>
  mutate(row_num = row_number())|>
  filter(row_num == 14)|>
  unnest_longer(col = zip_scraped)|>
  filter(str_length(zip_scraped) > 1)|>
  mutate(zip_code = str_extract(zip_scraped, pattern = "[0-9]{5}"))|>
  mutate(city = str_remove(zip_scraped, pattern = "[0-9]{5}"))|>
  dplyr::select(zip_code, city) -> li_zip_codes
```

```{r}
#Filter eo_ny by zip code. 
li_churches <- li_zip_codes|>
  left_join(eo_ny, by = "zip_code")
```

```{r}
#filter out non Christian churches with keywords. 
li_churches|>
  mutate(ntee_code = str_extract(NTEE_CD, pattern = "[0-9]{2}"),
         ntee_code = as.numeric(ntee_code))|>
  filter(is.na(ntee_code) | between(ntee_code, 20, 22))|>
  filter(!str_detect(NAME, regex("islam", ignore_case = TRUE)),
         !str_detect(NAME, regex("school", ignore_case = TRUE)),
         !str_detect(NAME, regex("trust", ignore_case = TRUE)),
         !str_detect(NAME, regex("israel", ignore_case = TRUE)),
         !str_detect(NAME, regex("synagogue", ignore_case = TRUE)),
         !str_detect(NAME, regex("quran", ignore_case = TRUE)),
         !str_detect(NAME, regex("synogogue", ignore_case = TRUE)),
         !str_detect(NAME, regex("masjid", ignore_case = TRUE)),
         !str_detect(NAME, regex("jew", ignore_case = TRUE)),
         !str_detect(NAME, regex("torah", ignore_case = TRUE)),
         !is.na(NAME))|>
  distinct(NAME, .keep_all = TRUE)-> li_churches
```

```{r}
#filter by coordinates
map_data_li|>
  summarize(max_lat = max(lat),
            min_lat = min(lat),
            max_lon = max(long),
            min_lon = min(long)) -> li_boundaries

li_churches_coordinates|>
  unnest_longer(col = geo_loc)|>
  filter(!str_detect(geo_loc, pattern = "NA"))|>
  unnest_wider(col = geo_loc)|>
  distinct(EIN, .keep_all = TRUE)|>
  mutate(lat = as.numeric(lat),
    lon = as.numeric(lon))|>
  filter(between(lat, li_boundaries$min_lat, li_boundaries$max_lat),
         between(lon, li_boundaries$min_lon, li_boundaries$max_lon))-> map_data
```


```{r}
#clean up column names, extract geoid
li_race_data |>
  janitor::clean_names()|>
  mutate(geoid = str_remove_all(geoid, pattern = "1500000US"))|>
  left_join(long_island_bg, by = "geoid")|>
  mutate(geoid = as.character(geoid)) -> li_race_data_clean
```


```{r}
#function to clean data from the census calls. 
clean_census_api_call <- function(df){
  df <- tibble(df)
  colname <- names(df)[1]
  df |>
    unnest_longer(col = colname)|>
    unnest_wider(col = colname, names_sep = "_")|>
    distinct()|>
    row_to_names(1)|>
    select(-ends_with("A"))|>
    mutate(GEOID = str_remove_all(geoid, pattern = "1500000US"))
}

cleaned_household <- clean_census_api_call(li_household_data)
cleaned_age <- clean_census_api_call(li_age_data)
cleaned_tenure <- clean_census_api_call(li_tenure_data)
cleaned_race <- clean_census_api_call(li_race_data)
cleaned_household_size <- clean_census_api_call(li_household_size)
cleaned_urban_rural <- clean_census_api_call(li_urban_rural)

```

```{r}
#create dataframes to receive the column names
create_prepped_df <- function(df){
  total_cols <- length(colnames(df))
  end_col <- total_cols - 4
  df|>
    select(1:end_col)|>
    select(-2)
}

prepped_tenure <- create_prepped_df(cleaned_tenure)
prepped_age <- create_prepped_df(cleaned_age)
prepped_household <- create_prepped_df(cleaned_household)
prepped_race <- create_prepped_df(cleaned_race)
prepped_household_size <- create_prepped_df(cleaned_household_size)
prepped_urban_rural <- create_prepped_df(cleaned_urban_rural)

```

```{r}
#add colnames to prepped dfs
colnames(prepped_tenure) <- tenure_cols[1, ]
colnames(prepped_age) <- age_cols[1, ]
colnames(prepped_household) <- household_cols[1, ]
colnames(prepped_race) <- race_cols[1, ]
colnames(prepped_household_size) <- household_cols[1, ]
colnames(prepped_urban_rural) <- urban_rural_cols[1, ]
```


```{r}
#spacial join
map_data_sf <- st_as_sf(map_data, coords = c("lon", "lat"), crs = 4326)
li_race_data_clean <- st_as_sf(li_race_data_clean, sf_column_name = "geometry")
st_crs(li_race_data_clean) <- 4326

st_crs(li_race_data_clean)
st_crs(map_data_sf)


joined_data <- st_join(map_data_sf, li_race_data_clean, join = st_within)
```