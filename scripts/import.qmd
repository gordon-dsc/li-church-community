---
title: "Data Import Script"
format: html
---

```{r packages}
library(tidyverse)
library(rvest)
library(readr)
library(httr2)
library(purrr)
library(janitor)
library(stringr)
library(sf)
```

```{r}
#irs data CSV
eo_ny <- read_csv("~/Desktop/dsc-210-final-proj/li-church-community/data/imported_data/eo_ny.csv")
```

```{r}
#function to use LocationIQ API to match address to coordinates.

url <- "https://us1.locationiq.com/v1/search"

geocode <- function(location){
  Sys.sleep(1)
  request(url)|>
    req_url_query(key = "pk.1f71792b3e75a36adb3bd38ceef8adf0",
                  q = location,
                  format = "json")|>
    req_perform()|>
    resp_body_json()
}

safe_geocode <- purrr::possibly(
  geocode,
  otherwise = list(lat = NA, lon = NA)
)

li_churches_coordinates <- li_churches|>
  mutate(geo_loc = purrr::map(.x = full_address,
                       .f = safe_geocode,
                       .progress = TRUE))
```
```{r}
#Scrape Long Island Zip Codes

zip_code_url <- "https://www.lifamilies.com/community/long-island-new-york-zip-codes.aspx"

read_html(zip_code_url)|>
  html_elements("div")|>
  html_text2()|>
  str_split("\n") -> zip_scraped

zip_codes <- tibble(zip_scraped)
```

```{r}
#shapefile imports
nassau_bg <- st_read("/Users/jamesccoats/Downloads/tl_2020_36059_bg20/tl_2020_36059_bg20.shp") |>
  st_transform(4326)

suffolk_bg <- st_read("/Users/jamesccoats/Downloads/tl_2020_36103_bg20/tl_2020_36103_bg20.shp")|>
  st_transform(4326)

long_island_bg <- bind_rows(nassau_bg, suffolk_bg)
```

```{r}
#function get census data by geoid, group. 
get_dhc_by_geoid <- function(geoid, group, key) {
  
  state  <- stringr::str_sub(geoid, 1, 2)
  county <- stringr::str_sub(geoid, 3, 5)
  tract  <- stringr::str_sub(geoid, 6, 11)
  
  base_url <- "https://api.census.gov/data/2020/dec/dhc"
  
  request(base_url) |>
    req_url_query(
      get = paste0("group(", group, ")"),
      `for` = paste0("tract:", tract),
      `in`  = paste0("state:", state, " county:", county),
      key   = key
    ) |>
    req_perform() |>
    resp_body_json()
}
```

```{r}
#geoids <- sc_census_block_group$GEOID
#geoids <- tibble(geoids)

sc_geo_id <- tibble(geo_id = suffolk_county_tract$FULLCODE)
nc_geo_id <- tibble(geo_id = nassau_county_tract$FULLCODE)


li_geo_id <- bind_rows(sc_geo_id, nc_geo_id)
  
```

```{r}
#scrape all dhc group surveys from census website 
#not used in final csv
census_dhc_url <- "https://api.census.gov/data/2020/dec/dhc/groups.html"

read_html(census_dhc_url)|>
  html_elements("td")|>
  html_text2()|>
  str_extract(pattern = "^.{1,7}$")|>
  str_remove(pattern = "RACE")|>
  str_remove(pattern = "TENURE")-> dhc_groups

```

```{r}
#use get_dhc_by_geoid function to collect long_island census information. 
key = "7dd0f70c686d841c0dbfc11f190405f2f2317073"
li_race_data <- purrr::map2(.x = race_geoids$geoids,
                            .y = race_geoids$survey,
                            ~ get_dhc_by_geoid(.x,
                                               .y,
                                               "7dd0f70c686d841c0dbfc11f190405f2f2317073"),
                            .progress = TRUE)
                                               
```

```{r}
li_race_data <- tibble(li_race_data)

li_race_data|>
  unnest_longer(col = li_race_data)|>
  unnest_wider(col = li_race_data, names_sep = "_")|>
  distinct()|>
  row_to_names(1)|>m
  select(-ends_with("A"))-> li_race_data

```

```{r}
#scrape P8 Colnames to better name columns. 
race_base_url <- "https://api.census.gov/data/2020/dec/dhc/groups/P8.html"

read_html(race_base_url)|>
  html_elements("td")|>
  html_text2()-> race_web_page
```


